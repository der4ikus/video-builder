#!/bin/bash
# –ó–∞–ø—É—Å–∫ Fast Video Builder —Å–µ—Ä–≤–∏—Å–æ–≤

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Fast Video Builder"
echo "============================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–µ
if [ ! -f "docker-compose.yml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –ø–∞–ø–∫–µ gpu-server"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª
if [ ! -f ".env" ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ ./scripts/setup.sh"
    exit 1
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .env

echo "üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
echo "  - –í–æ—Ä–∫–µ—Ä–æ–≤: ${WORKER_REPLICAS:-4}"
echo "  - API –ø–æ—Ä—Ç: ${API_PORT:-8000}"
echo "  - GPU –ª–∏–º–∏—Ç: ${GPU_MEMORY_LIMIT:-6144}MB"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose down 2>/dev/null || true

# –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
rm -rf /tmp/video_jobs/* 2>/dev/null || true

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
docker-compose up -d

# –ñ–¥–µ–º –ø–æ–∫–∞ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å—Ç—è—Ç—Å—è
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ API
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º API..."
for i in {1..30}; do
    if curl -s http://localhost:${API_PORT:-8000}/health > /dev/null; then
        echo "‚úÖ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
        break
    else
        echo "‚è≥ –ñ–¥–µ–º API —Å–µ—Ä–≤–µ—Ä... ($i/30)"
        sleep 2
    fi
done

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤
echo ""
echo "üìù –õ–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫):"
docker-compose logs --tail=10 worker

echo ""
echo "üéâ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo ""
echo "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ URL:"
echo "  - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:${API_PORT:-8000}/docs"
echo "  - –°—Ç–∞—Ç—É—Å API: http://localhost:${API_PORT:-8000}/health"
echo "  - MinIO –∫–æ–Ω—Å–æ–ª—å: http://localhost:9001 (admin/admin123)"
echo ""
echo "üìä –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - –õ–æ–≥–∏: docker-compose logs -f"
echo "  - –°—Ç–∞—Ç—É—Å: docker-compose ps"
echo "  - –û—Å—Ç–∞–Ω–æ–≤–∫–∞: docker-compose down"
echo "  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ GPU: watch -n 1 nvidia-smi"
echo ""
